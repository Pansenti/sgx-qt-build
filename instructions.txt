Notes for getting Qt OpenGL working on Gumstix Overo (draft)

The goal is to get a working 3.2 kernel Overo system with Qt embedded and OpenGL
support so we can run our custom Qt OpenGL apps on the Gumstix.

These instructions could probably be modified to support Qt-X11, but I don't use
X with the Gumstix and have not tried it.

The kernel and rootfs were built using Yocto. Qt and the TI graphics SDK are 
built outside of Yocto/OE, but using the same cross-build tools.

The assumption for all of this is that you have already successfully built a 
Gumstix image with a 3.2 kernel using Yocto. 

If your image contains Qt embedded then you should create a new image recipe 
that omits that. Qt will be built and installed separately.

The PowerVR drivers are closed-source. You can get them as part of the TI Linux 
Graphics SDK. There are different drivers based on the version of the SGX core. 
I'll be targeting the DM3730 core in this document, but I will point out the 
small configuration difference for the OMAP3530 core.


--------------------------------------------------------------------------------
HIGH LEVEL STEPS

1) Patch the kernel DSS driver and rebuild the 3.2 kernel

2) Build the kernel modules

3) Build Qt with the powervr plugin

4) Copy components to the Gumstix SD card

5) Finish install on the Gumstix

6) Run some demos



For the example, I am using a Yocto build where my TMPDIR is at /oe5.

The meta-layer I am using is called meta-pansenti. There is no requirement to 
use this layer, but paths referenced will have this name in them.

You can get it here : github.com/Pansenti/meta-pansenti

I am getting the kernel from Steve Sakoman's repository.

git://www.sakoman.com/git/linux-omap-2.6.git


--------------------------------------------------------------------------------
1. PATCH THE KERNEL DSS DRIVER AND REBUILD THE 3.2 KERNEL
--------------------------------------------------------------------------------

1) Download this patch from Robert Nelson

https://github.com/RobertCNelson/stable-kernel/tree/master/patches/sgx/0001-Revert-OMAP-DSS2-remove-update_mode-from-omapdss-v3.2.patch


The kernel recipe is here 

        meta-pansenti/recipes-kernel/linux/linux-sakoman_3.2.bb


Copy the patch file here

        meta-pansenti/recipes-kernel/linux/linux-sakoman-3.2/sgx/0001-Revert-OMAP-DSS2-remove-update_mode-from-omapdss-v3.2.patch


Then modify the kernel recipe, linux-sakoman_3.2.bb to add the DSS patch.
Here is what mine looks like. You don't need the libertas patch.

        require linux.inc

        DESCRIPTION = "Linux kernel for OMAP processors"
        KERNEL_IMAGETYPE = "uImage"

        COMPATIBLE_MACHINE = "overo"

        BOOT_SPLASH = ""

        PV = "3.2"

        S = "${WORKDIR}/git"

        SRCREV = "${AUTOREV}"
        SRC_URI = "git://www.sakoman.com/git/linux-omap-2.6.git;branch=omap-3.2;protocol=git \
	           file://defconfig \
                   file://libertas-async-fwload.patch \
                   file://sgx/0001-Revert-OMAP-DSS2-remove-update_mode-from-omapdss-v3.2.patch \
                  "


2) Rebuild the kernel with 

        bitbake -c cleansstate virtual/kernel
        bitbake virtual/kernel
	

3) Rebuild your image. It should not include Qt, but should include the tslib
packages.


4) You should probably install it onto an SD card and make sure everything is
still working before proceeding.


--------------------------------------------------------------------------------
2. BUILD THE KERNEL MODULES
--------------------------------------------------------------------------------

TI documentation for their Graphics SDK can be found here

http://processors.wiki.ti.com/index.php/Graphics_SDK_Quick_installation_and_user_guide

From the above wiki link in the table in the 'About Graphics SDK', it shows
that there are  differences in the SGX Core revisions used by the OMAP35xx and 
DM37xx SOCs.

As a result, the binaries from the SDK are specific to the SGX core you are
targetting.


1) Download the TI Graphics SDK from here

http://software-dl.ti.com/dsps/dsps_public_sw/sdo_sb/targetcontent/gfxsdk/latest/index_FDS.html

I am using version 4.08.00.01 of the SDK for this example.


2a) If you are on a 64-bit platform, I believe you need the 32-bit compatibility
libraries to execute the bin file. You should do this first. 

Ubuntu users can use this command

        sudo apt-get install ia32-libs

If you are on a 32-bit platform, this isn't necessary.


2b) Extract the SDK by running the binary: Graphics_SDK_setuplinux_4_08_00_01.bin 

The default extract location is 

        ~/Graphics_SDK_4_08_00_01 

which I'll use.

When prompted, you should select es3.x, es5.x and the SDK.


3) Add some Yocto built cross-tools to your PATH. Do this however you want. 
I have a script that I use for this kind of thing I call yocto-cross-env.sh

It looks like this

        # Setup paths to an Overo cross-build environment

        if [[ -z "${OETMP}" ]]; then
	    echo "Need an OETMP defined!"
            return 1
        fi

        export SYSROOTSDIR=${OETMP}/sysroots
        export STAGEDIR=${SYSROOTSDIR}/`uname -m`-linux/usr/bin
        
        export KERNELDIR=${SYSROOTSDIR}/overo/kernel
        
        PATH=${PATH}:${STAGEDIR}:${STAGEDIR}/armv7a-vfp-neon-poky-linux-gnueabi


Run it like this substituting the OETMP for your Yocto build.

        scott@quad:~$ export OETMP=/oe5
        scott@quad:~$ source yocto-cross-env.sh


4) Go to the ~/Graphics_SDK_4_08_00_01 directory and modify the Rules.make file,
just the user section, so that it looks something like this.


        ################# FIELDS MODIFIABLE BY THE USER ###############################
        ############### All the fields below are mandatory ############################
        
        # Set home area (ex /home/user/)
        HOME=/home/scott
         
        # Set Toolchain path (ex /home/user/toolchain/arago-2011.09/armv7a)
        CSTOOL_DIR=$(SYSROOTSDIR)/bin/armv7a-vfp-neon-poky-linux-gnueabi
        
        # Set Tool chain prefix (ex arm-arago-linux-gnueabi- )
        CSTOOL_PREFIX=arm-poky-linux-gnueabi-
        
        # Set kernel installation path ( ex /home/user/linux-04.00.01.13 )
        KERNEL_INSTALL_DIR=$(SYSROOTSDIR)/overo/kernel
        
        # Set Target filesystem path ( ex /home/user/targetfs )
        TARGETFS_INSTALL_DIR=
        
        ######################### PRE-DEFINED VARIABLES ###############################
        ######################## NOT MODIFIABLE BY USER ###############################
        ...

Note that I'm using SYSROOTSDIR from the yocto-source-me script.

It's okay to leave the TARGETFS_INSTALL_DIR empty.

5) Apply a small kernel definition patch to the SDK source

Copy the patch to the Graphics SDK directory

        scott@quad:~/Graphics_SDK_4_08_00_01$ cp ~/sgx-qt-build/4.08.00.01/omaplfb_freezable.patch .

Apply the patch

        scott@quad:~/Graphics_SDK_4_08_00_01$ patch -p1 < omaplfb_freezable.patch


6) Running 'make help' will show you the options.

        scott@quad:~/Graphics_SDK_4_08_00_01$ make help

        Usage (for build): make BUILD={debug | release} OMAPES={3.x | 5.x | 6.x | 8.x} FBDEV={yes | no} SUPPORT_XORG= {1 | 0 }  all
              Platform                                  OMAPES 
              --------                                  ------ 
              OMAP35x(SGX core 1.2.1)                    3.x   
              OMAP37x/AM37x(SGX core 1.2.5)              5.x   
              816x(389x)/814x(387x)(SGX core 1.2.5)      6.x   
              335x(SGX core 1.2.5 )                      8.x   
        --> Specifying OMAPES is mandatory. BUILD=release and FBDEV=yes SUPPORT_XORG=0(not enabled) by default
        Usage (for install): make BUILD=(debug | release} OMAPES={3.x | 5.x | 6.x | 8.x} EGLIMAGE={1 | 0} install
        --> See online Graphics Getting Started Guide for further details.


7) To build the kernel drivers for the DM3730, run the following

        scott@quad:~/Graphics_SDK_4_08_00_01$ make BUILD=release OMAPES=5.x FBDEV=yes


Ignore the warnings you get about devmem2.

When it completes, you should see some kernel modules in the gfx_rel_es5.x subdirectory.

        scott@quad:~/Graphics_SDK_4_08_00_01$ ls -l gfx_rel_es5.x/*.ko
        -rw-rw-r-- 1 scott scott  130076 Oct 24 13:54 gfx_rel_es5.x/bufferclass_ti.ko
        -rw-rw-r-- 1 scott scott  320884 Oct 24 13:54 gfx_rel_es5.x/omaplfb.ko
        -rw-rw-r-- 1 scott scott 2129793 Oct 24 13:54 gfx_rel_es5.x/pvrsrvkm.ko


If you were building for the OMAP3530, you would have run this make command

        scott@quad:~/Graphics_SDK_4_08_00_01$ make BUILD=release OMAPES=3.x FBDEV=yes


The OMAP3530 kernel modules will be in the gfx_rel_es3.x subdirectory.


That's all for the PowerVR drivers. 


--------------------------------------------------------------------------------
3. BUILD QT WITH THE POWERVR PLUGIN
--------------------------------------------------------------------------------

These instructions are for Qt version 4.8.3. The latest Qt4 version when I wrote
this.

To make the install a little easier and because I don't fully understand the
cross-build path dependencies for Qt, I'm going to install the cross-built Qt 
into /opt on both the build workstation and the Gumstix root filesystem. When
I get a chance to play around with this a little I'll experiment with putting
Qt in a better place. There are some font database location issues when the
build and final target destinations aren't the same. Building Qt is time 
consuming so I haven't debugged this.


1) Download the Qt source code from here

        http://releases.qt-project.org/qt4/source/qt-everywhere-opensource-src-4.8.3.tar.gz


2) Extract the Qt source code to a convenient directory for building. I'm going 
to use my home directory.

        scott@quad:~$ tar xzf /oe-sources/qt-everywhere-opensource-src-4.8.3.tar.gz


3) (Optional) Make a shorter soft link for convenience
    
        scott@quad:~$ ln -s qt-everywhere-opensource-src-4.8.3/ qt
        
        scott@quad:~$ ls -ld qt*
        lrwxrwxrwx  1 scott scott   35 Oct 24 14:30 qt -> qt-everywhere-opensource-src-4.8.3/
        drwxr-xr-x 16 scott scott 4096 Sep 12  2011 qt-everywhere-opensource-src-4.8.3


4) Apply this pvrqwswsegl.patch to the Qt source. 

Copy pvrqwswsegl.patch to the Qt source directory.

        scott@quad:~$ cp pvrqwswsegl.patch ~/qt

Apply the patch

        scott@quad:~$ cd qt
        scott@quad:~/qt$ patch -p1 < pvrqwswsegl.patch


4) Create a make specification (mkspec) for the overo under the qws directory
called linux-overo-g++ by copying the generic one.

        scott@quad:~$ cd qt/mkspecs/qws
        scott@quad:~/qt/mkspecs/qws$ cp -r linux-generic-g++/ linux-overo-g++
        scott@quad:~/qt/mkspecs/qws$ cd linux-overo-g++
        
Then edit the qmake.conf for the cross-build.

        scott@quad:~/qt/mkspecs/qws/linux-overo-g++$ <edit> qmake.conf

The resulting qmake.conf should look like this.

 	#
        # qmake configuration for building with arm-poky-linux-gnueabi-g++
        #
        
        include(../../common/linux.conf)
        include(../../common/gcc-base-unix.conf)
        include(../../common/g++-unix.conf)
        include(../../common/qws.conf)

        
        SGX_SDK_ROOT     = /home/scott/Graphics_SDK_4_06_00_02 
        CROSSBINDIR      = /oe5/sysroots/x86_64-linux/usr/bin/armv7a-vfp-neon-poky-linux-gnueabi
     
         
        # modifications to g++.conf
        QMAKE_CFLAGS_RELEASE    = -O3 -march=armv7-a -mtune=cortex-a8 -mfpu=neon -mfloat-abi=softfp
        QMAKE_CXXFLAGS_RELEASE  = -O3 -march=armv7-a -mtune=cortex-a8 -mfpu=neon -mfloat-abi=softfp
        
        QMAKE_CC         = $$CROSSBINDIR/arm-poky-linux-gnueabi-gcc
        QMAKE_CXX        = $$CROSSBINDIR/arm-poky-linux-gnueabi-g++
        QMAKE_LINK       = $$CROSSBINDIR/arm-poky-linux-gnueabi-g++
        QMAKE_LINK_SHLIB = $$CROSSBINDIR/arm-poky-linux-gnueabi-g++
        
        # modifications to linux.conf
        QMAKE_AR         = $$CROSSBINDIR/arm-poky-linux-gnueabi-ar cqs
        QMAKE_OBJCOPY    = $$CROSSBINDIR/arm-poky-linux-gnueabi-objcopy
        QMAKE_STRIP      = $$CROSSBINDIR/arm-poky-linux-gnueabi-strip
        
        load(qt_config)
        
          
        QMAKE_INCDIR_OPENGL_ES2 = $$SGX_SDK_ROOT/GFX_Linux_SDK/OGLES2/SDKPackage/Builds/OGLES2/Include/
        QMAKE_INCDIR_OPENGL_ES2 += $$SGX_SDK_ROOT/GFX_Linux_SDK/OGLES2/SDKPackage/Builds/OGLES2/LinuxOMAP3/Include/
        QMAKE_INCDIR_OPENGL_ES2 += $$SGX_SDK_ROOT/include
        QMAKE_INCDIR_OPENGL_ES2 += $$SGX_SDK_ROOT/GFX_Linux_SDK/OGLES/SDKPackage/Builds/OGLES/Include/
        QMAKE_INCDIR_OPENGL_ES2 += $$SGX_SDK_ROOT/include/pvr2d/
        QMAKE_INCDIR_OPENGL_ES2 += $$SGX_SDK_ROOT/include/OGLES2/
        QMAKE_INCDIR_OPENGL_ES2 += $$SGX_SDK_ROOT/include/wsegl/
        QMAKE_INCDIR_OPENGL_ES2 += $$SGX_SDK_ROOT/include/bufferclass_ti/
        QMAKE_INCDIR_OPENGL_ES2 += $$SGX_SDK_ROOT/include/OGLES/
        
        QMAKE_LIBDIR_OPENGL_ES2 = $$SGX_SDK_ROOT/gfx_rel_es5.x/ 
        QMAKE_LIBS_OPENGL_ES2   = -lEGL -lGLESv2 -lGLES_CM -lIMGegl -lsrv_um -lusc
        
        QMAKE_INCDIR_OPENGL     += $$SGX_SDK_ROOT/GFX_Linux_SDK/OGLES/SDKPackage/Builds/OGLES/Include/
        QMAKE_LIBDIR_OPENGL     = $$SGX_SDK_ROOT/gfx_rel_es5.x
        QMAKE_LIBDIR_OPENGL_QT  = $$SGX_SDK_ROOT/gfx_rel_es5.x
        QMAKE_LIBS_OPENGL_ES1   = -lEGL -lGLES_CM -lIMGegl -lsrv_um -lusc
         
        QMAKE_INCDIR_OPENVG     = $$SGX_SDK_ROOT/GFX_Linux_SDK/OVG/SDKPackage/Builds/OVG/Include/
        QMAKE_LIBDIR_OPENVG     = $$SGX_SDK_ROOT/gfx_rel_es5.x/
        QMAKE_LIBS_OPENVG       = -lEGL -lGLESv2 -lGLES_CM -lIMGegl -lsrv_um -lOpenVG -lOpenVGU
        
        QMAKE_INCDIR_EGL        = $$QMAKE_INCDIR_OPENGL_ES2
        QMAKE_INCDIR_EGL        += $$QT_INSTALL_DIR/src/3rdparty/powervr/wsegl2
        QMAKE_INCDIR_POWERVR    = $$QT_INSTALL_DIR/src/3rdparty/powervr/wsegl2
        QMAKE_LIBDIR_EGL        = $$QMAKE_LIBDIR_OPENGL_ES2
        QMAKE_LIBS_EGL          = -lEGL -lIMGegl -lsrv_um -lGLESv2 -lGLES_CM -lusc
        
        QMAKE_INCDIR += $$TSLIB_INCDIR 
        QMAKE_INCDIR += $$QMAKE_INCDIR_OPENGL_ES2
        QMAKE_LIBDIR += $$QMAKE_LIBDIR_OPENGL_ES2 
        QMAKE_LIBDIR += $$TSLIB_LIBDIR
        QMAKE_LIBS = $$QMAKE_LIBS_OPENGL_ES2


5) Create a new include directory in the TI Graphics SDK directory that Qt will
look for.
      
        scott@quad:~/qt/mkspecs/qws/linux-overo-g++$ cd ~/Graphics_SDK_4_06_00_02/include
        scott@quad:~/Graphics_SDK_4_06_00_02/include$ mkdir GLES
        scott@quad:~/Graphics_SDK_4_06_00_02/include$ cp OGLES2/EGL/eglplatform.h GLES/eglplatform.h


6) Configure Qt, targeting /opt for the eventual install. The /opt directory does not
get used until 'make install' is run later.

        scott@quad:~/qt$ ./configure -prefix /opt/qte -embedded arm -xplatform qws/linux-overo-g++ \
        -no-glib -no-cups -no-largefile -no-accessibility -no-openssl -no-gtkstyle \
        -no-3dnow -no-avx -no-mmx -no-sse -no-sse2 -no-sse3 -no-sse4.1 -no-sse4.2 \
        -little-endian -no-qt3support -opensource -confirm-license -fast \
        -D QT_NO_QWS_CURSOR -D QT_QWS_CLIENTBLIT \
         -depths 16,24,32 -qt-mouse-pc -plugin-mouse-pc \
        -opengl es2 -qt-gfx-linuxfb -plugin-gfx-powervr


7) Build Qt

        scott@quad:~/qt$ make


8) Install Qt on the local workstation to the /opt directory. This just collects
the libs, headers and demos/examples that need to go to the target into one 
location. They'll be copied to the Gumstix SD card in another step.

First change permissions for /opt.

        scott@quad:~/qt$ sudo chown -R scott:scott /opt

Then run the install step
        
        scott@quad:~/qt$ make install


You should have a new directory /opt/qte



--------------------------------------------------------------------------------
4. COPY COMPONENTS TO THE GUMSTIX SD CARD
--------------------------------------------------------------------------------

Setup your SD card as you usually would with a boot partition and rootfs.

On the system I writing this on, the SD card shows up as /dev/sdb. 
Remount the rootfs partition and copy over the TI Graphics components and the 
Qt software that was built above.

Mount the Gumstix rootfs partition

        scott@quad:~$ sudo mount /dev/sdb2 /media/card

Create an /opt directory on the Gumstix rootfs

        scott@quad:~$ sudo mkdir /media/card/opt

Copy the TI Graphics stuff

        scott@quad:~$ sudo cp -r ~/Graphics_SDK_4_06_00_02/gfx_rel_es5.x /media/card/opt

Copy Qt

        scott@quad:~$ sudo cp -r /opt/qte/ /media/card/opt

Unmount the SD card

        scott@quad:~$ sync
        scott@quad:~$ sudo umount /dev/sdb2


Put the SD card in the Gumstix and boot it.

--------------------------------------------------------------------------------
5. Finish install on the Gumstix
--------------------------------------------------------------------------------

1) Install the GFX components. This copies various GFX scripts, libraries, 
kernel modules and demo programs to standard locations.

        root@overo:~# cd /opt/gfx_rel_es5.x/
        root@overo:/opt/gfx_rel_es5.x# ./install.sh

You can ignore the message to reboot.

Run depmod to let the system know about the new drivers

        root@overo:/opt/gfx_rel_es5.x# depmod


2) The PowerVR software needs an initialization file that tells it about Qt.
Create an /etc/powervr.ini file that looks like this

        [default]
        WindowSystem=libpvrQWSWSEGL.so

Note: If you are interested in running non-Qt demos that came with the TI SDK
then you will want another library in place of libpvrQWSWSEGL.so.
TODO: Add the reference doc for this.


3) Add the Qt libraries to the library path. 

Add this line to /etc/ld.so.conf

        /opt/qte/lib

Then force a refresh of the run-time linker database

        root@overo:~# rm /etc/ld.so.cache
	root@overo:~# ldconfig -v


4) Load the kernel drivers. 

There is a script to do this in /etc/init.d called rc.pvr.

        root@overo:~# /etc/init.d/rc.pvr start

        root@overo:~# lsmod
        Module                  Size  Used by
        omaplfb                11582  0 
        pvrsrvkm              160943  1 omaplfb
        libertas_sdio          16208  0 
        libertas               99103  1 libertas_sdio
        cfg80211              165642  1 libertas
        rfkill                 17069  1 cfg80211
        lib80211                5017  1 libertas
        firmware_class          6797  2 libertas_sdio,libertas
        ads7846                10347  0 

Your modules may differ based on your kernel config. The important ones for this
are omaplfb and pvrsrvkm.

You can add rc.pvr to your startup scripts. 

--------------------------------------------------------------------------------
6. RUN SOME DEMOS
--------------------------------------------------------------------------------

At this point, I've only used a DVI connected display with this Qt/OpenGL system.

The kernel boot params that I've tried are

        vram=12M
        omapdss.def_disp=dvi

with the following resolutions

        omapfb.mode=dvi:1680x1050MR-16@60
        omapfb.mode=dvi:1280x1024MR-16@60
        omapfb.mode=dvi:1024x768MR-16@60
and
        omapfb.mode=dvi:640x480MR-32@60
        
You can adjust these settings in your u-boot environment.


There are some Qt demos under /opt/qte/examples/opengl

A fun one to try is hellogl_es2.

        root@overo:~# cd /opt/qte/examples/opengl/hellogl_es2
        root@overo:/opt/qte/examples/opengl/hellogl_es2# ./hellogl_es2 -qws -display powervr


For the 32-bit color 640x480 mode you have to specify a proper rgba setting first
or you'll get an error like this.

        root@overo:/opt/qte/examples/opengl/hellogl_es2# ./hellogl_es2 -qws -display powervr
        /dev/fb0: could not find a suitable PVR2D pixel format
        Could not initialize EGL display - are the drivers loaded?
        /dev/fb0: could not find a suitable PVR2D pixel format
        powervr: driver cannot connect
        Aborted

You can use fbset for this.

        root@overo:~# fbset

        mode "640x480-61"
            # D: 24.000 MHz, H: 30.000 kHz, V: 60.730 Hz
            geometry 640 480 640 480 32
            timings 41666 80 48 3 7 32 4
            rgba 8/16,8/8,8/0,0/0
        endmode
       
        root@overo:~# fbset -rgba 8/16,8/8,8/0,8/24

        root@overo:~# fbset

        mode "640x480-61"
            # D: 24.000 MHz, H: 30.000 kHz, V: 60.730 Hz
            geometry 640 480 640 480 32
            timings 41666 80 48 3 7 32 4
            rgba 8/16,8/8,8/0,8/24
        endmode

After that you can run the hellogl_es2 example and it should run at >100 fps
on a DM37xx at least.

The default fbset that gets installed is part of BusyBox and doesn't support
framebuffer mode changes like this.

You should include fbset as part of your Yocto image recipe. That version of
fbset (v2.1.x) will work.

        


